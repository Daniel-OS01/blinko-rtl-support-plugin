name: Release Pipeline

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Target Version (semver, patch, minor, major)'
        required: true
        default: 'patch'
        type: string
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    name: Build & Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun Environment
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install Dependencies
        run: bun install --frozen-lockfile

      # =========================================================
      # MANUAL RELEASE LOGIC
      # =========================================================
      - name: Configure Git (Manual)
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump Version (Manual)
        if: github.event_name == 'workflow_dispatch'
        id: bump
        run: |
          INPUT_VERSION="${{ inputs.version }}"
          echo "Processing Manual Release for version: $INPUT_VERSION"

          # 1. Update package.json version
          # npm version updates package.json and package-lock.json
          npm version $INPUT_VERSION --no-git-tag-version --allow-same-version

          # 2. Extract the resolved new version
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "Resolved Version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT

          # 3. Update plugin.json
          bun run scripts/update-plugin-version.js "$NEW_VERSION"

      - name: Build Production Artifacts
        run: |
          echo "Building production artifacts..."
          bun run build:prod
          # Verify output
          ls -R release/

      - name: Commit & Tag (Manual)
        if: github.event_name == 'workflow_dispatch'
        run: |
          NEW_TAG="${{ steps.bump.outputs.tag }}"
          NEW_VERSION="${{ steps.bump.outputs.version }}"

          echo "Committing changes for $NEW_TAG..."
          git add package.json plugin.json

          # We do NOT commit release/ folder to git, as it is a build artifact.
          # The user's prompt implied "update the index.js in the releases folder" -
          # but usually we don't commit build artifacts to the repo.
          # However, if the user specifically wants the repo to contain the build, we would add it.
          # The standard practice is to attach it to the release.
          # The prompt says: "The release action should first update the The current release action not updates the the index.js in the releases folder... Incomplete Main Branch Manual Releases... neither update all required project files... nor successfully generate and attach the release.zip"
          # It doesn't explicitly say "commit build artifacts to git". It says "update files... and attach release.zip".
          # So I will NOT commit `release/` to git unless I see it is already tracked.

          if [ -d "release" ]; then
             # Check if release/index.js is tracked
             if git ls-files --error-unmatch release/index.js >/dev/null 2>&1; then
                echo "release/index.js is tracked. Adding it to commit."
                git add release/
             fi
          fi

          git commit -m "chore(release): bump version to $NEW_VERSION [skip ci]"

          echo "Pushing changes and tag..."
          git tag "$NEW_TAG"
          git push origin main
          git push origin "$NEW_TAG"

      # =========================================================
      # PACKAGING & UPLOAD
      # =========================================================
      - name: Determine Release Tag
        id: release_tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ steps.bump.outputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release Archive
        run: |
          # Create a temporary directory for zipping to avoid clutter
          mkdir -p release_package

          # Copy build artifacts
          cp -r release/* release_package/

          # Copy metadata
          cp plugin.json release_package/
          cp README.md release_package/
          cp README_*.md release_package/ 2>/dev/null || true

          echo "Content of release package:"
          ls -R release_package/

          # Zip the content of release_package
          cd release_package
          zip -r ../release.zip .
          cd ..

          echo "release.zip created."

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release_tag.outputs.tag }}
          files: |
            release.zip
            release/index.js
          fail_on_unmatched_files: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
