name: Release Plugin

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Extract Version from Tag
        if: startsWith(github.ref, 'refs/tags/')
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Bump Version in Files
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          echo "Updating version to $VERSION"

          # Update package.json
          sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" package.json

          # Update plugin.json
          sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" plugin.json

      - name: Build for production
        run: bun run build:prod

      - name: Commit and Push Release Artifacts (Branch)
        if: github.ref_type == 'branch'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Force add the release directory
          git add release/

          if git diff --staged --quiet; then
            echo "No changes to release artifacts."
          else
            git commit -m "chore: update release artifacts [skip ci]"
            git push
          fi

      - name: Create Release Zip (Tag)
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          cd release
          zip -r ../release.zip .
          cd ..

      - name: Create Release and Commit Artifacts (Tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release.zip
            release/index.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit Version Updates and Artifacts (Tag)
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Add updated version files and release artifacts
          git add package.json plugin.json release/

          # Commit back to main (assuming we want to persist the version bump)
          # We need to fetch main first to ensure we can switch to it if we are on a detached tag
          git fetch origin main
          git checkout main
          git pull origin main

          # Re-apply changes (they might be lost on checkout if not stashed, but since we modified them in place on the detached head, let's stash and pop)
          # Actually, checkout might fail if files are dirty.
          # Safer approach:
          # 1. Stash changes
          # 2. Checkout main
          # 3. Apply changes (pop)
          # 4. Commit and push

          # BUT, if we are on a tag, the files are modified.
          # Let's simple commit to the tag reference? No, that's not good practice.
          # Best practice: Commit to main.

          git stash
          git checkout main
          git pull origin main
          git stash pop

          if git diff --staged --quiet && git diff --quiet; then
             echo "No changes to commit."
          else
             git add package.json plugin.json release/
             git commit -m "chore: bump version to ${{ steps.get_version.outputs.VERSION }} and update artifacts [skip ci]"
             git push origin main
          fi
