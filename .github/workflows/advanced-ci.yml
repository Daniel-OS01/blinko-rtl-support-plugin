name: Advanced CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '0 0 * * 0' # Weekly run to catch regressions in dependencies
  workflow_dispatch:

jobs:
  # 1. Functional & Technical Integrity
  verify-integrity:
    name: ğŸ›¡ï¸ Integrity & Unit Tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    - name: Install Dependencies
      run: bun install
    - name: Run Standard Tests
      run: bun test tests/unit tests/integration tests/services tests/utils tests/components tests/e2e
    - name: Build Production Artifact
      run: bun run build:prod

  # 2. Performance Gate
  performance-gate:
    name: ğŸš€ Performance Benchmarks
    runs-on: ubuntu-latest
    needs: verify-integrity
    steps:
    - uses: actions/checkout@v4
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    - name: Install Dependencies
      run: bun install
    - name: Run Benchmark
      run: bun run test:perf
      # Note: The test file itself contains the 'expect(duration).toBeLessThan(X)' assertion
      # which will cause this job to fail if the budget is exceeded.

  # 3. Accessibility Compliance
  a11y-compliance:
    name: â™¿ Accessibility Checks (WCAG/ARIA)
    runs-on: ubuntu-latest
    needs: verify-integrity
    steps:
    - uses: actions/checkout@v4
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    - name: Install Dependencies
      run: bun install
    - name: Run A11y Tests
      run: bun run test:a11y

  # 4. Cross-Environment Compatibility Matrix
  cross-env-matrix:
    name: ğŸŒ Cross-Env Compatibility
    runs-on: ubuntu-latest
    strategy:
      matrix:
        bun-version: ["1.0.0", "latest"]
    steps:
    - uses: actions/checkout@v4
    - name: Setup Bun (${{ matrix.bun-version }})
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: ${{ matrix.bun-version }}
    - name: Install Dependencies
      run: bun install
    - name: Verification Build
      run: bun run build:prod

  # 5. Security Scanning
  security-audit:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    - name: Install Dependencies
      run: bun install
    # Bun doesn't have a native 'audit' command like npm yet that is fully standard.
    # We can use npm audit as a proxy since lockfile exists, or a dedicated tool.
    # Falling back to npm audit for the lockfile if package-lock.json exists, else skip.
    - name: Dependency Vulnerability Scan
      run: |
        if [ -f package-lock.json ]; then
          npm audit --audit-level=high
        else
          echo "No package-lock.json found, skipping npm audit."
        fi
